---
###############################################################################
#
# Ansible remediation role for profile docker-host
# Profile Title:  Standard Docker Host Security Profile
# Profile Description:
# This profile contains rules to ensure standard security baseline
# of Red Hat Enterprise Linux 7 system running the docker daemon. This discussion
# is currently being held on open-scap-list@redhat.com and
# scap-security-guide@lists.fedorahosted.org.
#
#
# Benchmark ID:  RHEL-7
# Benchmark Version:  0.1.36
#
# XCCDF Version:  1.1
#
# This file was generated by OpenSCAP 1.2.16 using:
# 	$ oscap xccdf generate fix --fix-type ansible --profile docker-host --output docker_host.yml /usr/share/xml/scap/ssg/content/ssg-rhel7-xccdf.xml
#
# This script is generated from an OpenSCAP profile without preliminary evaluation.
# It attempts to fix every selected rule, even if the system is already compliant.
#
# How to apply this remediation role:
# $ ansible-playbook -i "192.168.1.155," docker_host.yml
# $ ansible-playbook -i inventory.ini docker_host.yml
#
###############################################################################

- hosts: all
  vars:
  tasks:
  - name: Ensure SELinux Not Disabled in /etc/default/grub
    replace:
      dest: /etc/default/grub
      regexp: selinux=0
    tags:
      - enable_selinux_bootloader
      - medium_severity
      - restrict_strategy
      - low_complexity
      - low_disruption
      - CCE-26961-3
      - NIST-800-53-AC-3
      - NIST-800-53-AC-3(3)
      - NIST-800-53-AC-3(4)
      - NIST-800-53-AC-4
      - NIST-800-53-AC-6
      - NIST-800-53-AU-9
      - NIST-800-53-SI-6(a)
      - NIST-800-171-3.1.2
      - NIST-800-171-3.7.2

  - name: XCCDF Value var_selinux_state # promote to variable
    set_fact:
      var_selinux_state: !!str |-
          enforcing
    tags:
      - always

  - name: "Ensure SELinux State is Enforcing"
    lineinfile:
      path: /etc/sysconfig/selinux
      regexp: '^SELINUX='
      line: "SELINUX={{ var_selinux_state }}"
      create: yes
    tags:
      - selinux_state
      - high_severity
      - restrict_strategy
      - low_complexity
      - low_disruption
      - CCE-27334-2
      - NIST-800-53-AC-3
      - NIST-800-53-AC-3(3)
      - NIST-800-53-AC-3(4)
      - NIST-800-53-AC-4
      - NIST-800-53-AC-6
      - NIST-800-53-AU-9
      - NIST-800-53-SI-6(a)
      - NIST-800-171-3.1.2
      - NIST-800-171-3.7.2
      - DISA-STIG-RHEL-07-020210

  - name: XCCDF Value var_selinux_policy_name # promote to variable
    set_fact:
      var_selinux_policy_name: !!str |-
          targeted
    tags:
      - always

  - name: "Configure SELinux Policy"
    lineinfile:
      path: /etc/sysconfig/selinux
      regexp: '^SELINUXTYPE='
      line: "SELINUXTYPE={{ var_selinux_policy_name }}"
      create: yes
    tags:
      - selinux_policytype
      - high_severity
      - restrict_strategy
      - low_complexity
      - low_disruption
      - CCE-27279-9
      - NIST-800-53-AC-3
      - NIST-800-53-AC-3(3)
      - NIST-800-53-AC-3(4)
      - NIST-800-53-AC-4
      - NIST-800-53-AC-6
      - NIST-800-53-AU-9
      - NIST-800-53-SI-6(a)
      - NIST-800-171-3.1.2
      - NIST-800-171-3.7.2
      - DISA-STIG-RHEL-07-020220

  - name: Enable service docker
    service:
      name="{{item}}"
      enabled="yes"
      state="started"
    with_items:
      - docker
    tags:
      - service_docker_enabled
      - medium_severity
      - enable_strategy
      - low_complexity
      - low_disruption
      - CCE-80440-1
...